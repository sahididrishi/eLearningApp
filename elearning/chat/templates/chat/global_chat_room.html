{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row justify-content-center" style="height: 80vh;">
    <div class="col-lg-10 h-100">
        <div class="glass-card h-100 d-flex flex-column overflow-hidden">
            <!-- Chat Header -->
            <div
                class="p-4 border-bottom border-secondary border-opacity-25 bg-dark bg-opacity-50 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary p-2 text-white me-3">
                        <i class="bi bi-hash fs-4"></i>
                    </div>
                    <div>
                        <h4 class="text-white mb-0">Global Community</h4>
                        <small class="text-success"><i class="bi bi-circle-fill" style="font-size: 8px;"></i>
                            Live</small>
                    </div>
                </div>
                <div class="d-flex">
                    <!-- Placeholder for future features -->
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div id="chat-log" class="flex-grow-1 p-4 overflow-auto" style="scroll-behavior: smooth;">
                <!-- Welcome Message -->
                <div class="text-center mb-4">
                    <span class="badge bg-secondary bg-opacity-25 text-light rounded-pill px-3 py-2">Today</span>
                </div>

                <div class="d-flex flex-column gap-3">
                    <!-- Example System Message -->
                    <div class="align-self-center text-theme-muted small fst-italic">
                        Welcome to the global chat room!
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-dark bg-opacity-50 border-top border-secondary border-opacity-25">
                <div class="input-group">
                    <button class="btn btn-outline-secondary border-end-0 rounded-start-pill ps-3" type="button">
                        <i class="bi bi-emoji-smile"></i>
                    </button>
                    <input id="chat-message-input" type="text"
                        class="form-control border-start-0 border-end-0 bg-transparent text-theme-main"
                        placeholder="Type your message..." style="box-shadow: none;">
                    <button class="btn btn-outline-secondary border-start-0 pe-3" type="button">
                        <i class="bi bi-paperclip"></i>
                    </button>
                    <button id="chat-message-send" class="btn btn-primary rounded-end-pill px-4 fw-bold">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const roomName = "global";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    const currentUser = "{{ user.username }}";

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById('chat-log');
        const messageContainer = document.querySelector('#chat-log > div.d-flex');

        const isMe = data.username === currentUser;

        // Create message element
        const msgDiv = document.createElement('div');
        msgDiv.className = `d-flex ${isMe ? 'justify-content-end' : 'justify-content-start'} mb-3 fade-in-up`;

        const avatarHtml = !isMe ? `
        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 35px; height: 35px; font-size: 0.8rem;">
            ${data.username.charAt(0).toUpperCase()}
        </div>
      ` : '';

        const bubbleClass = isMe ? 'bg-primary text-white' : 'glass-card text-theme-main';
        const roundedClass = isMe ? 'rounded-top-3 rounded-start-3' : 'rounded-top-3 rounded-end-3';

        msgDiv.innerHTML = `
        ${avatarHtml}
        <div class="d-flex flex-column ${isMe ? 'align-items-end' : 'align-items-start'}" style="max-width: 70%;">
            ${!isMe ? `<small class="text-theme-muted mb-1 ms-1" style="font-size: 0.75rem;">${data.username}</small>` : ''}
            <div class="p-3 ${bubbleClass} ${roundedClass}" style="word-wrap: break-word;">
                ${data.message}
            </div>
            <small class="text-theme-muted mt-1 mx-1" style="font-size: 0.7rem;">Just now</small>
        </div>
      `;

        messageContainer.appendChild(msgDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-message-send').onclick = function (e) {
        const inputEl = document.getElementById('chat-message-input');
        const message = inputEl.value;
        if (message.trim() !== '') {
            chatSocket.send(JSON.stringify({ 'message': message }));
            inputEl.value = '';
        }
    };

    document.getElementById('chat-message-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('chat-message-send').click();
        }
    });
</script>
{% endblock %}